<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="./css/common.css">
    <title>Page | Dashboard</title>
</head>
<body>
    <ul class="left-side">
        <li><img src="./imgs/Freddys_Logo.svg" alt=""></li>
        <li><a href="./dashboard.html">Dashboard</a></li>
        <li><a href="./orders.html">Orders</a></li>
        <li><a href="./login.html">Logout</a></li>
    </ul>
      
    <div class="right">
        <div class="top-part">
            <ul>
                <li>Dashboard</li>
            </ul>
        </div>
        <div class="overview">
            <div>
                <p>Today</p>
                <p>$1456 / 9 orders</p>
            </div>
            <div>
                <p>Last Week</p>
                <p>$34k / 120 orders</p>
            </div>
            <div>
                <p>Last Month</p>
                <p>$95k / 876 orders</p>
            </div>
        </div>
        <div class="card-body">
            <h5 class="card-title" style="float: left;">Revenue (last 7 days)</h5>
            <h5 style="float: right"><input onclick="renderChart(this)" week="" type="checkbox"></h5>
            <!-- Line Chart -->
            <div id="reportsChart" style="clear: both"></div>

            
            <!-- End Line Chart -->

        </div>
        <p>Bestsellers</p>
        <div class="bottom-part" style="margin-top: 20px">
            <table id="bestsellers">
                <tr>
                  <th>Product Name</th>
                  <th>Price</th>
                  <th># Units Sold</th>
                  <th>Revenue</th>
                </tr>
            </table>
        </div>
    </div>
        <script src="./apexcharts/apexcharts.min.js"> </script>
        
      <script>
        let bestSellers;
        let weekSales; 
        let yearSales;

        const year_x_label = ["This Month", "Last Month", "Month 3", "Month 4", "Month 5", "Month 6", "Month 7",
                "Month 8", "Month 9", "Month 10", "Month 11", "Month 12"];
        
        const week_x_label = ["Today", "Yesterday", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"]

        let uri = 'https://freddy.codesubmit.io/dashboard';

        let headers = new Headers();
        headers.append('Authorization', `Bearer ${localStorage.getItem('accessToken')}`);
        
        let request = new Request(uri, {
            headers: headers
        });

        fetch(request)
        .then(res=>res.json())
        .then(data=>{
            const dashboard = data.dashboard;
            bestSellers = dashboard.bestsellers;
            weekSales = dashboard.sales_over_time_week;
            yearSales = dashboard.sales_over_time_year;
            
            constructChart(weekSales, week_x_label);

            let row = null;
            let bs_table = document.getElementById('bestsellers');

            for(let prod of bestSellers){
                row = `<tr id='${prod.product.id}'>
                        <td>${prod.product.name}</td>
                        <td>$100</td>
                        <td>${prod.units}</td>
                        <td>${prod.revenue}</td>
                    </tr>
                `;
                bs_table.innerHTML += row;
            }

            
            console.log(data)
        })
        
        function constructChart(arg, xaxis_label){
    
            let orders = [];
            let totals = [];
            for(let i in arg){
                orders.push(arg[i]['orders'])
                totals.push(arg[i]['total'])
            }

            
              (() => {
                new ApexCharts(document.querySelector("#reportsChart"), {
                  series: [{
                    name: 'Orders',
                    data: orders,
                  }, {
                    name: 'Total',
                    data: totals
                  }],
                  chart: {
                    height: 350,
                    type: 'area',
                    toolbar: {
                      show: false
                    },
                  },
                  markers: {
                    size: 4
                  },
                  colors: ['#4154f1', '#2eca6a'],
                  fill: {
                    type: "gradient",
                    gradient: {
                      shadeIntensity: 1,
                      opacityFrom: 0.3,
                      opacityTo: 0.4,
                      stops: [0, 90, 100]
                    }
                  },
                  dataLabels: {
                    enabled: false
                  },
                  stroke: {
                    curve: 'smooth',
                    width: 2
                  },
                  xaxis: {
                    type: 'days',
                    categories: xaxis_label
                  },
                  tooltip: {
                    x: {
                      format: 'dd/MM/yy HH:mm'
                    },
                  }
                }).render();
              })();
        }
      
        function renderChart(el){
            
            if(!el.checked){
                constructChart(yearSales, year_x_label)
            }
            else{
                constructChart(weekSales, week_x_label);
            }
        }
      </script>
</body>
</html>